<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì¹µí…Œì¼ ì¶”ì²œ ì‚¬ì´íŠ¸ â€” AWS Lambda ì—°ë™</title>
  <style>
    /* --- Global --- */
    body {
      margin: 0;
      font-family: 'Inter', Arial, sans-serif;
      display: flex;
      height: 100vh;
      background: #0a0a0a;
      color: #f1f1f1;
    }

    /* --- Sidebar: ë„¤ì˜¨ë°” ìŠ¤íƒ€ì¼ --- */
    .sidebar {
      width: 340px;
      background: #000;
      color: #ffe9c9;
      padding: 24px;
      overflow-y: auto;
      border-right: 2px solid rgba(255, 77, 196, 0.3);
      box-shadow: 0 0 20px rgba(255,77,196,0.2);
    }

    .sidebar h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #ff4dc4;
      text-shadow: 0 0 6px #ff4dc4;
    }

    .category h3 {
      font-size: 16px;
      margin-top: 18px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: #ffd4ff;
      text-shadow: 0 0 4px #ff82e6;
    }

    .subitem {
      margin: 6px 0;
      display: flex;
      align-items: center;
      padding: 6px 4px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
    }

    .subitem:hover {
      background: rgba(255, 77, 196, 0.15);
      transform: translateX(4px);
    }

    /* --- Buttons --- */
    .btn {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
    }

    .btn-ghost {
      background: rgba(255, 255, 255, 0.05);
      color: #ffdede;
      border: 1px solid rgba(255,255,255,0.15);
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.12);
    }

    .btn-primary {
      background: #ff4dc4;
      color: white;
      box-shadow: 0 0 8px rgba(255, 77, 196, 0.7);
    }

    .btn-primary:hover {
      background: #ff31b6;
      box-shadow: 0 0 12px rgba(255, 77, 196, 0.9);
    }

    /* --- Main content: ì¹µí…Œì¼ ë©”ë‰´íŒ ë¶„ìœ„ê¸° --- */
    .content {
      flex: 1;
      padding: 32px;
      overflow-y: auto;
      background: radial-gradient(circle at top, #1a1a1a, #050505);
    }

    h2 {
      margin-top: 0;
      font-weight: 700;
      color: #ffa5e0;
      text-shadow: 0 0 6px #ff4dc4;
    }

    /* --- Loading spinner --- */
    .loading {
      text-align: center;
      padding: 40px;
      color: #ff4dc4;
    }

    .spinner {
      border: 4px solid rgba(255,77,196,0.1);
      border-top: 4px solid #ff4dc4;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* --- Cocktail cards: ë„¤ì˜¨ í”„ë ˆì„ --- */
    .cocktail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 18px;
    }

    .card {
      background: rgba(255,255,255,0.05);
      padding: 20px;
      border-radius: 14px;
      border: 1px solid rgba(255, 77, 196, 0.25);
      backdrop-filter: blur(6px);
      box-shadow: 0 0 12px rgba(255,77,196,0.15);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
      color: #f1f1f1;
      position: relative;
    }

    .card:hover {
      transform: translateY(-4px) scale(1.03);
      box-shadow: 0 0 20px rgba(255,77,196,0.35);
      border-color: rgba(255, 77, 196, 0.45);
    }

    .card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #ffa5e0;
    }

    .card-ingredients {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 8px;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-alcoholic {
      background: rgba(255,77,196,0.3);
      color: #ffb3e6;
    }

    .badge-non-alcoholic {
      background: rgba(77,255,196,0.3);
      color: #b3ffe6;
    }

    /* --- Modal: ê³ ê¸‰ ê¸€ë¼ìŠ¤ ëŠë‚Œ --- */
    .modal-bg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
      z-index: 1000;
    }

    .modal {
      background: rgba(30, 30, 30, 0.98);
      padding: 32px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      border-radius: 18px;
      border: 1px solid rgba(255,77,196,0.4);
      color: #ffeefc;
      box-shadow: 0 0 30px rgba(255,77,196,0.5);
      animation: fadeIn 0.3s ease;
    }

    .modal img {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .modal h2 {
      margin-top: 0;
      color: #ff4dc4;
    }

    .modal-section {
      margin: 16px 0;
      padding: 12px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      border-left: 3px solid #ff4dc4;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h1>ğŸ¸ ì¬ë£Œ ì„ íƒ</h1>
    <p style="font-size:12px; opacity:0.7">í•„í„° ëª¨ë“œ ì„ íƒ í›„ ì¬ë£Œë¥¼ ì²´í¬í•˜ì„¸ìš”</p>

    <label style="font-size:13px; display:block; margin-bottom:10px;">
      í•„í„° ëª¨ë“œ:
      <select id="matchMode" onchange="applyFilter()">
        <option value="any">í•˜ë‚˜ë¼ë„ í¬í•¨(OR)</option>
        <option value="all">ëª¨ë‘ í¬í•¨(AND)</option>
      </select>
    </label>

    <button class="btn btn-ghost" onclick="resetFilter()">ì´ˆê¸°í™”</button>
    <br/><br/>

    <h2 style="font-size:18px">ì¬ë£Œ ì¹´í…Œê³ ë¦¬</h2>
    <div id="autoCategories"></div>

    <hr style="margin:20px 0; opacity:0.3" />

    <h2 style="font-size:18px">ë‚´ê°€ ê°€ì§„ ì¬ë£Œ</h2>
    <p style="font-size:12px; opacity:0.7">ë³´ìœ í•œ ì¬ë£Œë§Œìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ì¹µí…Œì¼ ì¶”ì²œ</p>
    <button class="btn btn-primary" onclick="recommendByMyIngredients()">ë§Œë“¤ ìˆ˜ ìˆëŠ” ì¹µí…Œì¼ ë³´ê¸°</button>
  </aside>

  <main class="content">
    <h2>ì¹µí…Œì¼ ëª©ë¡</h2>
    <p style="font-size:12px; opacity:0.6">
      ì „ì²´: <span id="totalCount">0</span>ê°œ | 
      ì„ íƒëœ ì¬ë£Œ: <span id="selectedList">ì—†ìŒ</span>
    </p>
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>ì¹µí…Œì¼ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
    <div id="cocktails" class="cocktail-grid"></div>
  </main>

  <!-- ìƒì„¸ ëª¨ë‹¬ -->
  <div id="modal-bg" class="modal-bg" onclick="closeModalBackground(event)">
    <div class="modal" id="modal" onclick="event.stopPropagation()"></div>
  </div>

  <script>
    //--------------------------------------------------
    // ğŸ”§ API ì„¤ì •
    //--------------------------------------------------
    const API_CONFIG = {
      BASE_URL: 'https://twuhm34ibb.execute-api.ap-northeast-2.amazonaws.com/cocktail-stage',
      ENDPOINTS: {
        GET: '/cocktail',
      }
    };

    //--------------------------------------------------
    // ì „ì—­ ë³€ìˆ˜
    //--------------------------------------------------
    let cocktailsDB = [];
    const cocktailsEl = document.getElementById('cocktails');
    const selectedListEl = document.getElementById('selectedList');
    const loadingEl = document.getElementById('loading');
    const totalCountEl = document.getElementById('totalCount');

    //--------------------------------------------------
    // ì¬ë£Œ ì¹´í…Œê³ ë¦¬ ê·œì¹™ (ì‹¤ì œ ì¬ë£Œëª… ê¸°ë°˜)
    //--------------------------------------------------
    const categoryRules = {
      'ë³´ë“œì¹´ ë² ì´ìŠ¤': ['Vodka', 'Absolut Citron', 'Absolut Vodka', 'Stoli Vodka'],
      'ì§„ ë² ì´ìŠ¤': ['Gin'],
      'ëŸ¼ ë² ì´ìŠ¤': ['Rum', 'Light rum', 'Dark rum', 'White rum', 'Malibu rum', 'Bacardi', 'Jamaican Dark rum'],
      'ë°í‚¬ë¼ ë² ì´ìŠ¤': ['Tequila', 'Gold tequila'],
      'ìœ„ìŠ¤í‚¤ ë² ì´ìŠ¤': ['Bourbon', 'Whiskey', 'Jack Daniels', 'Blended Bourbon'],
      'ë¦¬íë¥´': ['Kahlua', 'Blue Curacao', 'Peach schnapps', 'Triple sec', 'Triple Sec', 
                'Cointreau', 'Grand Marnier', 'Midori melon liqueur', 'Grenadine',
                'Sweet Vermouth', 'Dry Vermouth', 'Raspberry Liqueur', 'Galliano',
                'Orange Curacao', 'Strawberry liqueur', 'Creme de Cacao', 'Amaretto',
                'Pisco', 'Aperol', "Bailey's irish cream", 'Cherry Grenadine'],
      'ì£¼ìŠ¤': ['Orange juice', 'Cranberry juice', 'Cranberry Juice', 'Pineapple juice',
              'Lime juice', 'Lemon juice', 'Lemon Juice', 'Fresh Lime Juice', 
              'Fresh Lemon Juice', 'Grapefruit juice'],
      'ê³¼ì¼': ['Lime', 'Lemon', 'Orange', 'Pineapple', 'Strawberry'],
      'íƒ„ì‚°': ['Soda water', 'Sprite', 'Ginger ale', 'Club soda', 'Tonic', 'Cola'],
      'ê¸°íƒ€': ['Sugar', 'Sugar syrup', 'Simple syrup', 'Milk', 'Cream', 'Heavy cream',
              'Sweet and sour', 'Sour mix', 'Mint', 'Ice', 'Water', 'Salt',
              'Angostura bitters', 'Olive', 'Maraschino cherry', 'Egg White']
    };

    //--------------------------------------------------
    // ğŸŒ API í˜¸ì¶œ: ì „ì²´ ì¹µí…Œì¼ ê°€ì ¸ì˜¤ê¸°
    //--------------------------------------------------
    async function fetchCocktails() {
      try {
        loadingEl.style.display = 'block';
          const response = await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.GET}`);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        // API ì‘ë‹µ í™•ì¸ìš© ë¡œê·¸
        console.log('API ì‘ë‹µ:', data);

        // ë‹¤ì–‘í•œ ì‘ë‹µ í˜•ì‹ ì²˜ë¦¬
        let cocktailData = null;

        // AWS Lambda ì‘ë‹µ í˜•ì‹ ì²˜ë¦¬: { statusCode: 200, body: "stringified JSON" }
        if (data.statusCode === 200 && data.body) {
          const parsedBody = typeof data.body === 'string' ? JSON.parse(data.body) : data.body;
          console.log('íŒŒì‹±ëœ body:', parsedBody);

          if (parsedBody.success && parsedBody.data) {
            cocktailData = parsedBody.data;
          } else if (Array.isArray(parsedBody)) {
            cocktailData = parsedBody;
          }
        } else if (data.success && data.data) {
          // í˜•ì‹ 1: { success: true, data: [...] }
          cocktailData = data.data;
        } else if (Array.isArray(data)) {
          // í˜•ì‹ 2: ë°°ì—´ ì§ì ‘ ë°˜í™˜ [...]
          cocktailData = data;
        } else if (data.body) {
          // í˜•ì‹ 3: { body: [...] } ë˜ëŠ” { body: "stringified JSON" }
          const parsedBody = typeof data.body === 'string' ? JSON.parse(data.body) : data.body;
          if (parsedBody.success && parsedBody.data) {
            cocktailData = parsedBody.data;
          } else if (Array.isArray(parsedBody)) {
            cocktailData = parsedBody;
          }
        }

        if (!cocktailData) {
          throw new Error('ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
        }

        if (Array.isArray(cocktailData)) {
          cocktailsDB = cocktailData.map(c => ({
            name: c.name,
            isAlcohol: c.isAlcohol,
            picture: c.picture,
            glass: c.Glass || c.glass,
            instruction: c.instruction,
            recipe: c.ingredients_combined || c.recipe,
            ingredients: parseIngredientsList(c.ingredients_list)
          }));

          totalCountEl.textContent = cocktailsDB.length;
          renderAutoCategories();
          renderCocktails(cocktailsDB);
        } else {
          throw new Error('ì¹µí…Œì¼ ë°ì´í„°ê°€ ë°°ì—´ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('API Error:', error);
        cocktailsEl.innerHTML = `
          <div style="grid-column: 1/-1; text-align:center; padding:40px; color:#ff4dc4;">
            <h3>âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
            <p style="opacity:0.7">${error.message}</p>
            <p style="font-size:12px; opacity:0.5">ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì„ ì—´ì–´ 'API ì‘ë‹µ'ì„ í™•ì¸í•˜ì„¸ìš”.</p>
          </div>
        `;
      } finally {
        loadingEl.style.display = 'none';
      }
    }

    //--------------------------------------------------
    // ì¬ë£Œ ë¦¬ìŠ¤íŠ¸ íŒŒì‹± (ë¬¸ìì—´ â†’ ë°°ì—´)
    //--------------------------------------------------
    function parseIngredientsList(str) {
      try {
        // "['Vodka', 'Lime']" í˜•ì‹ì„ ë°°ì—´ë¡œ ë³€í™˜
        return eval(str);
      } catch {
        return [];
      }
    }

    //--------------------------------------------------
    // DBì—ì„œ ì‹¤ì œ ì¬ë£Œ ì¶”ì¶œ
    //--------------------------------------------------
    function extractIngredients() {
      const set = new Set();
      cocktailsDB.forEach(c => c.ingredients.forEach(i => set.add(i)));
      return Array.from(set).sort();
    }

    //--------------------------------------------------
    // ìë™ ì¹´í…Œê³ ë¦¬ ë Œë”ë§
    //--------------------------------------------------
    function renderAutoCategories() {
      const allIngredients = extractIngredients();
      const wrap = document.getElementById('autoCategories');
      wrap.innerHTML = '';

      const categorized = new Set();

      Object.entries(categoryRules).forEach(([cat, items]) => {
        const matchedItems = items.filter(i => allIngredients.includes(i));
        
        if (matchedItems.length === 0) return; // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ì¬ë£Œ ì—†ìœ¼ë©´ ìŠ¤í‚µ

        const box = document.createElement('div');
        box.className = 'category';
        let html = `<h3>${cat} (${matchedItems.length})</h3>`;

        matchedItems.forEach(i => {
          categorized.add(i);
          html += `
            <label class="subitem">
              <input class="ingredient-checkbox" type="checkbox" data-ingredient="${i}">
              ${i}
            </label>
          `;
        });

        box.innerHTML = html;
        wrap.appendChild(box);
      });

      // ê¸°íƒ€ ì¹´í…Œê³ ë¦¬ (ë§¤í•‘ ì•ˆëœ ì¬ë£Œ)
      const uncategorized = allIngredients.filter(i => !categorized.has(i));
      if (uncategorized.length > 0) {
        const box = document.createElement('div');
        box.className = 'category';
        let html = `<h3>ê¸°íƒ€ (${uncategorized.length})</h3>`;
        
        uncategorized.forEach(i => {
          html += `
            <label class="subitem">
              <input class="ingredient-checkbox" type="checkbox" data-ingredient="${i}">
              ${i}
            </label>
          `;
        });
        
        box.innerHTML = html;
        wrap.appendChild(box);
      }

      // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document.querySelectorAll('.ingredient-checkbox').forEach(ch => {
        ch.addEventListener('change', () => applyFilter());
      });
    }

    //--------------------------------------------------
    // ì¹µí…Œì¼ ì¹´ë“œ ë Œë”ë§
    //--------------------------------------------------
    function renderCocktails(list) {
      cocktailsEl.innerHTML = '';
      
      if (list.length === 0) {
        cocktailsEl.innerHTML = `
          <div style="grid-column: 1/-1; text-align:center; padding:40px; opacity:0.6;">
            <h3>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ë‹¤ë¥¸ ì¬ë£Œë¥¼ ì„ íƒí•´ë³´ì„¸ìš”.</p>
          </div>
        `;
        return;
      }

      list.forEach(c => {
        const card = document.createElement('div');
        card.className = 'card';
        card.onclick = () => openModal(c);
        
        const alcoholBadge = c.isAlcohol === 'Alcoholic' 
          ? '<span class="badge badge-alcoholic">ì•Œì½”ì˜¬</span>'
          : c.isAlcohol === 'Non alcoholic'
          ? '<span class="badge badge-non-alcoholic">ë…¼ì•Œì½”ì˜¬</span>'
          : '';
        
        card.innerHTML = `
          <img src="${c.picture}" alt="${c.name}" onerror="this.src='https://via.placeholder.com/280x180?text=No+Image'">
          <div class="card-title">${c.name}</div>
          ${alcoholBadge}
          <div class="card-ingredients">
            ${c.ingredients.slice(0, 3).join(', ')}${c.ingredients.length > 3 ? '...' : ''}
          </div>
        `;
        cocktailsEl.appendChild(card);
      });
    }

    //--------------------------------------------------
    // ì„ íƒëœ ì¬ë£Œ ê°€ì ¸ì˜¤ê¸°
    //--------------------------------------------------
    function getSelectedIngredients() {
      return Array.from(document.querySelectorAll('input[type=checkbox]:checked'))
        .map(c => c.dataset.ingredient);
    }

    //--------------------------------------------------
    // í•„í„° ì ìš©
    //--------------------------------------------------
    function applyFilter() {
      const selected = getSelectedIngredients();
      selectedListEl.textContent = selected.length ? selected.join(', ') : 'ì—†ìŒ';
      const mode = document.getElementById('matchMode').value;
      
      if (!selected.length) {
        return renderCocktails(cocktailsDB);
      }

      const filtered = cocktailsDB.filter(c => {
        return mode === 'any'
          ? selected.some(s => c.ingredients.includes(s))
          : selected.every(s => c.ingredients.includes(s));
      });

      renderCocktails(filtered);
    }

    //--------------------------------------------------
    // í•„í„° ì´ˆê¸°í™”
    //--------------------------------------------------
    function resetFilter() {
      document.querySelectorAll('input[type=checkbox]').forEach(c => c.checked = false);
      selectedListEl.textContent = 'ì—†ìŒ';
      renderCocktails(cocktailsDB);
    }

    //--------------------------------------------------
    // ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
    //--------------------------------------------------
    function openModal(c) {
      const m = document.getElementById('modal');
      
      const alcoholBadge = c.isAlcohol === 'Alcoholic' 
        ? '<span class="badge badge-alcoholic">ì•Œì½”ì˜¬</span>'
        : c.isAlcohol === 'Non alcoholic'
        ? '<span class="badge badge-non-alcoholic">ë…¼ì•Œì½”ì˜¬</span>'
        : '';
      
      m.innerHTML = `
        <img src="${c.picture}" alt="${c.name}" onerror="this.src='https://via.placeholder.com/600x300?text=No+Image'">
        <h2>${c.name} ${alcoholBadge}</h2>
        
        <div class="modal-section">
          <strong>ğŸ¥ƒ ê¸€ë¼ìŠ¤:</strong> ${c.glass || 'ì •ë³´ ì—†ìŒ'}
        </div>
        
        <div class="modal-section">
          <strong>ğŸ¹ ì¬ë£Œ:</strong><br>
          ${c.recipe || c.ingredients.join(', ')}
        </div>
        
        <div class="modal-section">
          <strong>ğŸ“ ë§Œë“œëŠ” ë²•:</strong><br>
          ${c.instruction || 'ì •ë³´ ì—†ìŒ'}
        </div>
        
        <button class="btn btn-primary" onclick="closeModal()">ë‹«ê¸°</button>
      `;
      
      document.getElementById('modal-bg').style.display = 'flex';
    }

    //--------------------------------------------------
    // ëª¨ë‹¬ ë‹«ê¸°
    //--------------------------------------------------
    function closeModal() {
      document.getElementById('modal-bg').style.display = 'none';
    }

    function closeModalBackground(event) {
      if (event.target.id === 'modal-bg') {
        closeModal();
      }
    }

    //--------------------------------------------------
    // ë‚´ê°€ ê°€ì§„ ì¬ë£Œë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ì¹µí…Œì¼ ì¶”ì²œ
    //--------------------------------------------------
    function recommendByMyIngredients() {
      const my = getSelectedIngredients();
      
      if (!my.length) {
        alert('ë³´ìœ  ì¬ë£Œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!');
        return;
      }

      const result = cocktailsDB.filter(c =>
        c.ingredients.every(i => my.includes(i))
      );

      if (!result.length) {
        alert('í˜„ì¬ ê°€ì§„ ì¬ë£Œë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ì¹µí…Œì¼ì´ ì—†ìŠµë‹ˆë‹¤.\nì¬ë£Œë¥¼ ë” ì¶”ê°€í•´ë³´ì„¸ìš”!');
      }
      
      renderCocktails(result);
    }

    //--------------------------------------------------
    // ğŸš€ ì´ˆê¸° ì‹¤í–‰
    //--------------------------------------------------
    fetchCocktails();
  </script>
</body>
</html>